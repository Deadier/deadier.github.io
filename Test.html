<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Compteur pylônes & antennes – ANFR (Explore v2.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.4; margin: 2rem; }
    label { display:block; margin-top:.5rem; }
    input, select, button { font-size: 1rem; padding:.35rem .5rem; }
    table { border-collapse: collapse; margin-top:1rem; width:100%; max-width:1100px; }
    th, td { border:1px solid #ddd; padding:.4rem .5rem; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    tfoot td { font-weight:700; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end; margin:.5rem 0 1rem; }
    .muted { color:#666; font-size:.9rem; }
    .ok { color: #116611; }
    .warn { color: #995500; }
    .error { color: #992222; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Compter pylônes et antennes par opérateur (ANFR / Explore v2.1)</h1>

  <div class="row">
    <label>Latitude<br><input id="lat" type="number" step="any" value="48.8566"></label>
    <label>Longitude<br><input id="lon" type="number" step="any" value="2.3522"></label>
    <label>Rayon (mètres)<br><input id="radius" type="number" step="1" value="2500"></label>
    <label>Région<br>
      <select id="region">
        <option value="metropole" selected>métropole</option>
        <option value="antilles">antilles-guyane</option>
      </select>
    </label>
    <button id="run">Calculer</button>
    <button id="openMap">Ouvrir la carte ANFR</button>
  </div>

  <div id="meta" class="muted">Chargement du schéma du jeu de données…</div>

  <table id="tbl">
    <thead>
      <tr>
        <th>opérateur</th>
        <th>pylônes (supports) uniques</th>
        <th>2G</th><th>3G</th><th>4G</th><th>5G</th>
        <th>total antennes</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
    <tfoot>
      <tr>
        <td>tous opérateurs</td>
        <td id="sumPylons">–</td>
        <td id="sum2g">–</td><td id="sum3g">–</td><td id="sum4g">–</td><td id="sum5g">–</td>
        <td id="sumAllAnt">–</td>
      </tr>
    </tfoot>
  </table>

  <p class="muted">
    Source : jeu <span class="mono">observatoire_2g_3g_4g</span> – ANFR. Comptage limité aux statuts <em>En service</em> (2G/3G/4G)
    et <em>Techniquement opérationnel</em> (5G). Les filtres géographiques utilisent un cercle via <span class="mono">within_distance()</span>.
  </p>

<script>
(async () => {
  const DATASET = "observatoire_2g_3g_4g";
  const BASE = "https://data.anfr.fr/api/explore/v2.1/catalog/datasets/" + DATASET + "/records";
  const INFO = "https://data.anfr.fr/api/explore/v2.1/catalog/datasets/" + DATASET;

  // opérateurs par zone (identifiants exacts de la facette adm_lb_nom)
  const OPS_METRO = ["ORANGE","BOUYGUES TELECOM","SFR","FREE MOBILE"];
  const OPS_ANTIL = ["ORANGE","FREE CARAIBES","DIGICEL","OUTREMER TELECOM"];

  let GEO_FIELD = "geo_point_2d"; // valeur de repli (confirmée sur la page d’info ANFR)
  let lastUpdated = null;

  // récupère le schéma et identifie le premier champ de type géographique (geo_point puis geo_shape)
  async function detectGeoField() {
    try {
      const r = await fetch(INFO);
      if (!r.ok) throw new Error("info HTTP " + r.status);
      const j = await r.json();
      const fields = (j && j.dataset && j.dataset.schema && j.dataset.schema.fields) || [];
      const geoPoint = fields.find(f => f.type && f.type.toLowerCase().includes("geo_point"));
      const geoShape = fields.find(f => f.type && f.type.toLowerCase().includes("geo_shape"));
      GEO_FIELD = geoPoint?.name || geoShape?.name || GEO_FIELD;
      lastUpdated = j?.dataset?.metas?.data_processed || j?.dataset?.metas?.modified;
      document.getElementById("meta").innerHTML =
        `Champ géographique détecté : <span class="mono ok">${GEO_FIELD}</span>` +
        (lastUpdated ? ` — dernière mise à jour dataset : <span class="mono">${lastUpdated}</span>` : "");
    } catch (e) {
      document.getElementById("meta").innerHTML =
        `Impossible de lire le schéma du dataset (utilisation du repli <span class="mono warn">${GEO_FIELD}</span>).`;
    }
  }

  // utilitaire de construction d’URL Explore v2.1
  function buildUrl(params) {
    const qs = new URLSearchParams(params);
    return BASE + "?" + qs.toString();
  }

  // prédicat géographique (cercle) – WKT POINT(lon lat), distance en mètres
  function whereWithin(lat, lon, radius) {
    const wkt = `POINT(${lon} ${lat})`;
    return `within_distance(${GEO_FIELD}, GEOM'${wkt}', ${radius} m)`;
  }

  // filtres de statut « actifs »
  const ACTIVE_REFINES = [
    "statut:En service",
    "statut:Techniquement opérationnel"
  ];

  // compte antennes par génération pour un opérateur
  async function countsByGeneration(op, lat, lon, radius) {
    const url = buildUrl({
      select: "generation, count(1) as n",
      where: whereWithin(lat, lon, radius),
      "group_by": "generation",
      limit: "10",
      lang: "fr",
      refine: [
        `adm_lb_nom:${op}`,
        ...ACTIVE_REFINES
      ]
    });
    const r = await fetch(url);
    if (!r.ok) throw new Error("HTTP " + r.status + " on " + url);
    return (await r.json()).results || [];
  }

  // compte pylônes uniques (supports) pour un opérateur
  async function countDistinctPylons(op, lat, lon, radius) {
    const url = buildUrl({
      select: "count(distinct(sup_id)) as pylones",
      where: whereWithin(lat, lon, radius),
      limit: "1",
      lang: "fr",
      refine: [
        `adm_lb_nom:${op}`,
        ...ACTIVE_REFINES
      ]
    });
    const r = await fetch(url);
    if (!r.ok) throw new Error("HTTP " + r.status + " on " + url);
    const res = (await r.json()).results?.[0];
    return res ? (res.pylones ?? 0) : 0;
  }

  // compte pylônes uniques tous opérateurs
  async function countAllPylons(lat, lon, radius) {
    const url = buildUrl({
      select: "count(distinct(sup_id)) as pylones",
      where: whereWithin(lat, lon, radius),
      limit: "1",
      lang: "fr",
      refine: ACTIVE_REFINES
    });
    const r = await fetch(url);
    if (!r.ok) throw new Error("HTTP " + r.status + " on " + url);
    const res = (await r.json()).results?.[0];
    return res ? (res.pylones ?? 0) : 0;
  }

  // additionne proprement les générations (manque = 0)
  function toRow(operator, groups) {
    const m = new Map(groups.map(g => [String(g.generation).toUpperCase(), Number(g.n)]));
    const g2 = m.get("2G") || 0, g3 = m.get("3G") || 0, g4 = m.get("4G") || 0, g5 = m.get("5G") || 0;
    return { operator, g2, g3, g4, g5, total: g2+g3+g4+g5 };
  }

  // UI
  async function run() {
    const lat = Number(document.getElementById("lat").value);
    const lon = Number(document.getElementById("lon").value);
    const radius = Math.max(1, Number(document.getElementById("radius").value|0));
    const region = document.getElementById("region").value;
    const ops = (region === "antilles") ? OPS_ANTIL : OPS_METRO;

    const tbody = document.getElementById("body");
    tbody.innerHTML = `<tr><td colspan="7" class="muted">Calcul en cours…</td></tr>`;

    try {
      // par opérateur : 2 requêtes (group_by + distinct supports)
      const promises = ops.map(async op => {
        const [groups, pylones] = await Promise.all([
          countsByGeneration(op, lat, lon, radius),
          countDistinctPylons(op, lat, lon, radius)
        ]);
        const row = toRow(op, groups);
        row.pylones = pylones;
        return row;
      });

      const rows = await Promise.all(promises);

      // rendu du tableau
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.operator}</td>
          <td>${r.pylones.toLocaleString('fr-FR')}</td>
          <td>${r.g2.toLocaleString('fr-FR')}</td>
          <td>${r.g3.toLocaleString('fr-FR')}</td>
          <td>${r.g4.toLocaleString('fr-FR')}</td>
          <td>${r.g5.toLocaleString('fr-FR')}</td>
          <td>${r.total.toLocaleString('fr-FR')}</td>
        </tr>
      `).join("");

      // totaux
      const sum = rows.reduce((a, r) => ({
        pyl: a.pyl + r.pylones, g2:a.g2+r.g2, g3:a.g3+r.g3, g4:a.g4+r.g4, g5:a.g5+r.g5, tot:a.tot+r.total
      }), {pyl:0,g2:0,g3:0,g4:0,g5:0,tot:0});
      document.getElementById("sumPylons").textContent = (await countAllPylons(lat, lon, radius)).toLocaleString('fr-FR');
      document.getElementById("sum2g").textContent = sum.g2.toLocaleString('fr-FR');
      document.getElementById("sum3g").textContent = sum.g3.toLocaleString('fr-FR');
      document.getElementById("sum4g").textContent = sum.g4.toLocaleString('fr-FR');
      document.getElementById("sum5g").textContent = sum.g5.toLocaleString('fr-FR');
      document.getElementById("sumAllAnt").textContent = sum.tot.toLocaleString('fr-FR');

    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="7" class="error">Erreur : ${e.message}</td></tr>`;
    }
  }

  // lien carte ANFR (mêmes filtres principaux)
  function openMap() {
    const lat = Number(document.getElementById("lat").value);
    const lon = Number(document.getElementById("lon").value);
    const radius = Math.max(1, Number(document.getElementById("radius").value|0));
    // reprend les statuts « actifs »
    const url = new URL("https://data.anfr.fr/visualisation/frame/map/");
    url.searchParams.set("id", DATASET);
    url.searchParams.append("refine.statut", "En service");
    url.searchParams.append("refine.statut", "Techniquement opérationnel");
    url.searchParams.set("geofilter.distance", `${lat},${lon},${radius}`);
    // centrage/zoom : ANFR accepte location=zoom,lat,lon
    url.searchParams.set("location", `12,${lat},${lon}`);
    window.open(url.toString(), "_blank");
  }

  await detectGeoField();
  document.getElementById("run").addEventListener("click", run);
  document.getElementById("openMap").addEventListener("click", openMap);
})();
</script>
</body>
</html>
